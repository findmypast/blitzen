version: '2'

vars:
  image: findmypast/blitzen

tasks:

  cli:
    description: Test the cli locally
    do: shell
    command: node bin/index

  lint:
    description: Lint your javascript
    do: shell
    command: eslint ./src/ --max-warnings=0

  test:
    description: Run tests
    do: shell
    command: nyc mocha --opts test/local.opts src/**/*spec.js

  test_ci:
    description: Run tests inside docker image
    do: shell
    command: nyc mocha --opts test/teamcity.opts src/**/*spec.js

  publish_to_npm:
    description: Publish the module to NPM
    do: sequence
    actions:
      - description: Create the .npmrc files locally
        do: shell
        command: supersoaker squirt -r https://registry.npmjs.org
      - description: Use the npm module publish to publish the module
        do: shell
        command: publish

  docker_lint:
    description: Lint your javascript
    do: shell
    command: docker run --rm <%=image%> usher run lint

  docker_build:
    description: Build docker image
    do: shell
    command: docker build --force-rm --no-cache -t <%=image%> .

  docker_usher_list:
    description: Build docker image
    do: shell
    command: docker run --rm <%=image%> usher list

  docker_publish_to_npm:
    description: Publish to NPM within the docker container
    do: shell
    command: docker run -e NPM_USER -e NPM_PASSWORD -e NPM_EMAIL --rm <%=image%> usher run publish_to_npm
    env:
      NPM_USER: <%=npm_user%>
      NPM_PASSWORD: <%=npm_password%>
      NPM_EMAIL: <%=npm_email%>
