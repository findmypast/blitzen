version: '2'

vars:
  image: findmypast/blitzen

tasks:

  cli:
    description: Test the cli locally
    do: shell
    command: npm run cli

  lint:
    description: Lint your javascript
    do: shell
    command: npm run lint

  test:
    description: Run tests
    do: shell
    command: npm run test

  test_ci:
    description: Run tests inside docker image
    do: shell
    command: npm run test_ci

  pre_push:
    description: git Pre push
    do: sequence
    actions:
      - do: lint
      - do: test

  publish_to_npm:
    description: Publish the module to NPM
    do: sequence
    actions:
      - description: Create the .npmrc files locally
        do: shell
        command: npm run publish_add_creds
      - description: Use the npm module publish to publish the module
        do: shell
        command: npm run publish_to_npm

  docker_build:
    description: Build docker image
    do: shell
    command: docker build --force-rm --no-cache -t <%=image%> .

  docker_publish_to_npm:
    description: Publish to NPM within the docker container
    do: shell
    command: docker run -e NPM_USER -e NPM_PASSWORD -e NPM_EMAIL --rm <%=image%> usher run publish_to_npm
    env:
      NPM_USER: <%=npm_user%>
      NPM_PASSWORD: <%=npm_password%>
      NPM_EMAIL: <%=npm_email%>

  setup:
    description: Publish the module to NPM
    do: sequence
    actions:
    - description: Install pre-push shell file
      do: shell
      command: cp scripts/pre-push .git/hooks
    - description: Change the permissions
      do: shell
      command: chmod +x .git/hooks/pre-push
